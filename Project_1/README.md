# Azure Infrastructure Operations Project: Deploying a Scalable IaaS Web Server in Azure

## Introduction
For this project, I have written a Packer template and a Terraform template to deploy a customizable, scalable web server in Azure.

## Getting Started
1. Clone this repository
2. Follow the instructions below
3. The outputs folders contains the output of terraform and packer executions
4. The tag_policy folder contains the required tagging policy specification for the project

## Dependencies
1. Windows 10 or later
2. Create an [Azure Account](https://portal.azure.com) 
3. Install the [Azure command line interface](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest)
4. Install [Packer](https://www.packer.io/downloads)
5. Install [Terraform](https://www.terraform.io/downloads.html)


## Instructions

### Create and Assign a Tagging Policy in Azure:
1. Go to the Azure Portal and create a new policy for tagging.
2. Assign the policy to your desired location/subscription in Azure.
3. The policy rule can be found in the file `tagging_policy.json` located in the folder tag_policy.

### Configure The Project:
1. Open the project in Visual Studio Code.
2. Go to the file `SetupAzureForPackerBuild.ps1` and set the values of the variables to your desired values:
   - `$subscriptionId` to your own Azure subscription ID.
   - `$resourceGroupName` = `"myResourceGroup"`.
   - `$location` = `"East US"`.
   - `$imageName` = `"myPackerImage"`.
   - `$ownerTag` = `"DevOps"`.
   - `$environmentTag` = `"Development"`.
   - `$storageAccountName = "mystorageaccountcrs1t"`.
3. Ensure that these values also match the values of the variables specified variales.tf file: 
   - variable "resource_group_name" 
   - variable "location" variable "tags" 
   - variable "subscription_id"  
   - variable "image_resource_group_name"
   - variable "backend_resource_group_name" 
   - variable "backend_storage_account_name"
   - variable "image_name"
   The backend.tf and variables.tf file will be generated by the Powershell script.   
4. Refer to this link for finding your Azure subscription ID: [Azure Subscription ID](https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id).

### Update `variables.tf`:
1. Ensure that the values for the variables defined in step 2 of Configure the Project match the values defined in the `variables.tf` file.

### Open PowerShell:
1. Open a PowerShell window
2. Go to the main directoty of the project using the cd command
3. Go to the terraform-azure-vm directory using the cd command

### Login to Azure:
1. Login using the Azure CLI in PowerShell if not logged in already.

### Execute the Setup Script:
1. Run the following command in PowerShell: `.\SetupAzureForPackerBuild.ps1`.
   - **Result:** No errors should be displayed in the PowerShell command window.
   - You should see the following message: `Setup completed. You can now proceed with running Packer using these credentials and configurations.`
   - The created resources should be visible in the Azure portal.

### Build with Packer:
1. Run the following command in PowerShell: `packer build -force server.json`.
   - **Result:** No errors should be displayed in the PowerShell command window.
   - You should see the following message: `Build 'azure-arm' finished after 4 minutes 23 seconds.`
     - **Wait completed after 4 minutes 23 seconds**
     - **Builds finished. The artifacts of successful builds are:**

### Initialize Terraform:
1. Run the following command in PowerShell: `terraform init`.
   - **Result:** You should see the following message: `Terraform has been successfully initialized!`

### Plan with Terraform:
1. Run the following command in PowerShell: `terraform plan -out="solution.plan"`.
   - **Result:** No errors should be displayed in the PowerShell command window.
   - You should see the following message: `Saved the plan to: solution.plan`.

### Apply with Terraform:
1. Run the following command in PowerShell: `terraform apply "solution.plan"`.
   - **Result:** No errors should be displayed in the PowerShell command window.
   - You should see the following message or similar: `Apply complete! Resources: 17 added, 0 changed, 0 destroyed.`

### List VM IP Addresses:
1. Run the following command in PowerShell: `az vm list-ip-addresses --resource-group myResourceGroup --output table`.
   - **Result:** You should see a table similar to the one below:

    ```
    VirtualMachine    PublicIPAddresses    PrivateIPAddresses
    ----------------  -------------------  --------------------
    myVM-0            xxx.xxx.xxx.xxx      10.x.x.x
    myVM-1            xxx.xxx.xxx.xxx      10.x.x.x
    ```

### Access the Web Page:
1. Use the public IP address to view the webpage served from the Azure virtual machines: `http://xxx.xxx.xxx.xxx`.

### Destroy Resources:
1. If you are ready to destroy the resources, run the following command in PowerShell: `terraform plan -destroy -out="destroy.plan"`.
   - **Result:** No errors should be displayed in the PowerShell command window.
   - You should see the following message or similar: `Plan: 0 to add, 0 to change, 17 to destroy.`
     - `Saved the plan to: destroy.plan`

### Apply Destroy Plan:
1. Run the following command in PowerShell: `terraform apply "destroy.plan"`.
   - **Result:** You should see the following message or similar: `Apply complete! Resources: 0 added, 0 changed, 17 destroyed.`

## Output
The output of the deployment includes the IP addresses of the deployed virtual machines, allowing access to the hosted web application. Additionally, confirmation messages from Terraform and Packer provide a clear indication of the deployment progress and status. The final result should be a set of Azure resources that match the configurations defined in the Terraform and Packer templates, which can be verified in the Azure portal. If needed, the resources can be cleanly destroyed using the Terraform destroy commands.

# Description of the SetupAzureForPackerBuild.ps1 script
The `SetupAzureForPackerBuild.ps1` script automates the setup process for deploying a scalable web server infrastructure in Azure using Packer and Terraform. The script performs the following steps:

1. **Define Variables**: Sets variables for Azure subscription ID, resource group name, location, image name, tags, storage account name, container name, and key.

2. **Obtain Azure Service Principal Credentials**: Creates a service principal with Contributor role in the specified Azure subscription and extracts the necessary credentials (Client ID, Client Secret, Tenant ID).

3. **Set Environment Variables**: Sets environment variables for Packer and Terraform using the obtained service principal credentials and the defined variables.

4. **Create Resource Group, Storage Account, and Container for Terraform State**:
    - Checks if the specified resource group exists and creates it if not.
    - Checks if the specified storage account exists and creates it if not.
    - Retrieves the storage account key.
    - Checks if the specified storage container exists and creates it if not.

5. **Create Configuration Files**:
    - Generates a `backend.tf` file for Terraform backend configuration using the specified resource group, storage account, container, and key.
    - Generates a `terraform.tfvars` file with backend configuration variables.

6. **Output Completion Message**: Displays a message indicating that the setup is completed and that the user can proceed with running Packer and Terraform using the generated credentials and configurations.


## Customizing the Deployment
To customize this deployment, you can modify the variables in the `variables.tf` file. Hereâ€™s a short description of how to change it:

1. **Azure subscription ID**:
   - Variable: `subscription_id`
   - Default: `"6fe6105a-78a2-472c-b075-5840c51586de"`
   - Description: Set this to your Azure subscription ID.

2. **Resource Group Name**:
   - Variable: `resource_group_name`
   - Default: `"myResourceGroup"`
   - Description: Name of the resource group where resources will be deployed.

3. **Azure Region**:
   - Variable: `location`
   - Default: `"eastus"`
   - Description: The Azure region where resources will be deployed.

4. **Tags to apply to resources**:
   - Variable: `tags`
   - Default: 
     ```json
     {
       Environment = "Development"
       Owner       = "DevOps"
     }
     ```
   - Description: Tags to organize your Azure resources.

5. **Size of the virtual machine**:
   - Variable: `vm_size`
   - Default: `"Standard_B1s"`
   - Description: The size/type of the virtual machine to be deployed.

6. **Admin username for the virtual machine**:
   - Variable: `admin_username`
   - Default: `"azureuser"`
   - Description: The admin username for accessing the virtual machine.

7. **Name of the managed image to use for the VM**:
   - Variable: `image_name`
   - Default: `"myPackerImage"`
   - Description: The name of the managed image to use for the virtual machine.

8. **Resource Group of the managed image to use for the VM**:
   - Variable: `image_resource_group_name`
   - Default: `"myResourceGroup"`
   - Description: The resource group containing the managed image.

9. **Number of virtual machines to deploy**:
   - Variable: `vm_count`
   - Default: `2`
   - Description: The number of virtual machines to deploy. Can be between 2 and 5.
   - Validation: Ensures the number is between 2 and 5.

10. **Load balancer SKU**:
    - Variable: `lb_sku`
    - Default: `"Standard"`
    - Description: SKU for the Load Balancer.

11. **Frontend port for the Load Balancer**:
    - Variable: `frontend_port`
    - Default: `80`
    - Description: Frontend port for the Load Balancer.

12. **Backend port for the Load Balancer**:
    - Variable: `backend_port`
    - Default: `80`
    - Description: Backend port for the Load Balancer.

13. **Protocol for the Load Balancer**:
    - Variable: `lb_protocol`
    - Default: `"Tcp"`
    - Description: Protocol for the Load Balancer.

14. **Backend configuration variables**:
    - Variables: `backend_resource_group_name`, `backend_storage_account_name`, `backend_container_name`, `backend_key`
    - Defaults:
      ```json
      "myResourceGroup"
      "mystorageaccountcrs1"
      "terraform-state"
      "terraform.tfstate"
      ```
    - Description: Variables related to the backend configuration for storing the Terraform state.

15. **VM Name**:
    - Variable: `vm_name`
    - Default: `"myVM"`
    - Description: The name of the VM.


